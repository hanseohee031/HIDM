{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/ai_matching.css' %}">
{% endblock %}

{% block content %}
  <div class="ai-header">
    <h1>AI Matching</h1>
    <a href="{% url 'ai_matching' %}?refresh=1" class="btn-refresh">
      {% if refreshed %}Refreshed{% else %}Refresh Recommendations{% endif %}
    </a>
  </div>

  {% if error %}
    <p class="error">{{ error }}</p>
  {% else %}
    <div class="ai-container">
      <!-- 왼쪽: 추천 리스트 -->
      <aside class="ai-sidebar">
        <h2>Recommendations</h2>
        {% include 'accounts/partials/ai_matches.html' %}
      </aside>

      <!-- 가운데: (선택 시) 프로필+폼 영역 -->
      <main class="ai-main" id="profile-and-form">
        <p>Select one of the recommendations on the left to send a chat request.</p>
      </main>

      <!-- 오른쪽: 요청 현황 -->
      <section class="ai-requests">
        <h2>Sent Requests</h2>
        <ul>
          {% for req in sent_requests %}
            <li>
              {% if req.receiver.userprofile.nickname %}
                {{ req.receiver.userprofile.nickname }}
              {% else %}
                {{ req.receiver.username }}
              {% endif %}
              <ul>
                <li>{{ req.slot1 }}</li>
                <li>{{ req.slot2 }}</li>
                <li>{{ req.slot3 }}</li>
              </ul>
              <form method="post" action="{% url 'chat_request_reject' req.pk %}">
                {% csrf_token %}
                <button type="submit">Cancel</button>
              </form>
            </li>
          {% empty %}
            <li>No sent requests.</li>
          {% endfor %}
        </ul>

        <h2>Received Requests</h2>
        <ul>
          {% for req in received_requests %}
            <li>
              {% if req.sender.userprofile.nickname %}
                {{ req.sender.userprofile.nickname }}
              {% else %}
                {{ req.sender.username }}
              {% endif %}
              <ul>
                <li>
                  {{ req.slot1 }}
                  <a href="{% url 'chat_request_confirm' req.pk 0 %}">Confirm</a>
                </li>
                <li>
                  {{ req.slot2 }}
                  <a href="{% url 'chat_request_confirm' req.pk 1 %}">Confirm</a>
                </li>
                <li>
                  {{ req.slot3 }}
                  <a href="{% url 'chat_request_confirm' req.pk 2 %}">Confirm</a>
                </li>
              </ul>
              <form method="post" action="{% url 'chat_request_reject' req.pk %}">
                {% csrf_token %}
                <button type="submit">Reject</button>
              </form>
            </li>
          {% empty %}
            <li>No incoming requests.</li>
          {% endfor %}
        </ul>

        <h2>Confirmed Chats</h2>
        <ul>
          {% for req in confirmed_chats %}
            {% if req.sender == user %}
              <li>
                Chat with
                {% if req.receiver.userprofile.nickname %}
                  {{ req.receiver.userprofile.nickname }}
                {% else %}
                  {{ req.receiver.username }}
                {% endif %}
                at {{ req.chosen_slot }}
              </li>
            {% else %}
              <li>
                Chat with
                {% if req.sender.userprofile.nickname %}
                  {{ req.sender.userprofile.nickname }}
                {% else %}
                  {{ req.sender.username }}
                {% endif %}
                at {{ req.chosen_slot }}
              </li>
            {% endif %}
          {% empty %}
            <li>No confirmed chats.</li>
          {% endfor %}
        </ul>
      </section>
    </div>
  {% endif %}
{% endblock %}
