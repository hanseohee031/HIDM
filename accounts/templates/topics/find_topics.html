{# templates/accounts/topics/find_topics.html #}
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h1 class="mb-4">Find Topics</h1>

  <div class="row">
    <!-- ÏôºÏ™Ω: Ï†ÑÏ≤¥ ÌÜ†ÌîΩ -->
    <div class="col-md-8">
      <!-- Clear All -->
      <form action="{% url 'find_topics' %}" method="post" class="mb-3 text-end">
        {% csrf_token %}
        <button type="submit" name="clear_all" class="btn btn-sm btn-warning">
          <i class="bi bi-x-circle"></i> Clear All
        </button>
      </form>

      <!-- Add a New Topic -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Add a New Topic</h5>
        </div>
        <div class="card-body">
          <form action="{% url 'find_topics' %}" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" name="add_topic"
                    class="btn btn-success">
              Add
            </button>
          </form>
        </div>
      </div>

      <!-- Accordion: Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌÜ†ÌîΩ -->
      <div class="accordion" id="topicsAccordion">
        {% for category in categories %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ forloop.counter }}"
                      aria-expanded="false"
                      aria-controls="collapse{{ forloop.counter }}">
                {{ category.name }}
              </button>
            </h2>
            <div id="collapse{{ forloop.counter }}"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading{{ forloop.counter }}"
                 data-bs-parent="#topicsAccordion">
              <div class="accordion-body p-0">
                <ul class="list-group list-group-flush">
                  {% for topic in category.topics.all|dictsortreversed:"score" %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ topic.title }}</strong><br>
                        <small class="text-muted">
                          by
                          {% if topic.created_by %}
                            {{ topic.created_by.userprofile.nickname }}
                          {% else %}
                            <span class="badge bg-secondary">basic</span>
                          {% endif %}
                        </small>
                      </div>
                      <div class="btn-group btn-group-sm">
                        <!-- Select/Remove -->
                        <form action="{% url 'find_topics' %}" method="post" class="me-1">
                          {% csrf_token %}
                          <input type="hidden" name="topic_id" value="{{ topic.id }}">
                          {% if topic in user_topics %}
                            <button type="submit" name="deselect_topic"
                                    class="btn btn-outline-danger">
                              Remove
                            </button>
                          {% else %}
                            <button type="submit" name="select_topic"
                                    class="btn btn-outline-success">
                              Select
                            </button>
                          {% endif %}
                        </form>
                        <!-- Delete (ÏûëÏÑ±ÏûêÎßå) -->
                        {% if topic.created_by == request.user %}
                          <form action="{% url 'find_topics' %}" method="post" class="me-1">
                            {% csrf_token %}
                            <input type="hidden" name="topic_id" value="{{ topic.id }}">
                            <button type="submit" name="delete_topic"
                                    class="btn btn-outline-danger">
                              Delete
                            </button>
                          </form>
                        {% endif %}
                        <!-- Up/Down votes -->
                        <a href="{% url 'vote_topic' topic.id 'up' %}"
                           class="btn btn-outline-success">
                          üëç {{ topic.upvotes.count }}
                        </a>
                        <a href="{% url 'vote_topic' topic.id 'down' %}"
                           class="btn btn-outline-danger">
                          üëé {{ topic.downvotes.count }}
                        </a>
                      </div>
                    </li>
                  {% empty %}
                    <li class="list-group-item text-center text-muted py-3">
                      No topics in this category.
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Ïò§Î•∏Ï™Ω: My Topics -->
    <div class="col-md-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">My Topics ({{ user_topics|length }})</h5>
        </div>
        <ul class="list-group list-group-flush">
          {% for topic in user_topics %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ topic.title }}</span>
              <form action="{% url 'find_topics' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="topic_id" value="{{ topic.id }}">
                <button type="submit" name="deselect_topic"
                        class="btn btn-sm btn-outline-danger">
                  Remove
                </button>
              </form>
            </li>
          {% empty %}
            <li class="list-group-item text-center text-muted">
              ÏïÑÏßÅ ÏÑ†ÌÉùÎêú ÌÜ†ÌîΩÏù¥ ÏóÜÏäµÎãàÎã§.
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
